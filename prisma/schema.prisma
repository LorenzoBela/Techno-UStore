generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres"]
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  user
  admin
}

enum OrderStatus {
  pending
  awaiting_payment
  ready_for_pickup
  completed
  cancelled
}

enum PaymentStatus {
  pending
  verified
  rejected
}

model User {
  id        String    @id // This will be the Supabase Auth user ID (UUID)
  email     String    @unique
  name      String?
  phone     String?
  role      UserRole  @default(user)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  orders    Order[]
  cart      Cart?
  wishlist  Wishlist?

  @@index([role]) // For admin user lookups
  @@index([createdAt(sort: Desc)]) // For recent users
}

model Category {
  id            String        @id @default(uuid())
  name          String        @unique
  slug          String        @unique
  description   String?
  image         String?       // Optional image/icon URL for navbar
  displayOrder  Int           @default(0) // Order in navbar
  isActive      Boolean       @default(true) // Show/hide in navbar
  products      Product[]
  subcategories Subcategory[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([isActive, displayOrder])
}

model Subcategory {
  id          String    @id @default(uuid())
  name        String
  slug        String
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([categoryId, slug])
  @@index([categoryId])
}

model Product {
  id            String           @id @default(uuid())
  name          String
  slug          String           @unique
  description   String?
  subcategory   String?          // Legacy field for backward compatibility
  subcategoryId String?          // New relation to Subcategory
  subcategoryRel Subcategory?    @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  price         Decimal
  stock         Int
  isFeatured    Boolean          @default(false) // Featured products for homepage showcase
  categoryId    String
  category      Category         @relation(fields: [categoryId], references: [id])
  images        ProductImage[]
  orderItems    OrderItem[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  variants      ProductVariant[]

  // Critical indexes for 2K+ products at scale
  @@index([categoryId]) // Category filtering
  @@index([categoryId, createdAt(sort: Desc)]) // Category page with sorting
  @@index([categoryId, price]) // Category + price filtering
  @@index([subcategory]) // Legacy subcategory filtering
  @@index([subcategoryId]) // New subcategory filtering
  @@index([createdAt(sort: Desc)]) // Recent products / pagination
  @@index([price]) // Price range filtering
  @@index([stock]) // Low stock alerts
  @@index([name]) // Name search (basic)
  @@index([isFeatured]) // Featured products lookup
}

model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name      String? // Variant name like "Navy Blue - Large"
  size      String
  color     String?
  stock     Int     @default(0)
  imageUrl  String?

  @@index([productId]) // Variant lookups
  @@index([size]) // Size filtering
  @@index([productId, size]) // Product + size combo
}

model ProductImage {
  id        String   @id @default(uuid())
  url       String
  alt       String?
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([productId]) // Image lookups by product
}

model Order {
  id            String      @id @default(uuid())
  userId        String? // Nullable for guest checkout
  user          User?       @relation(fields: [userId], references: [id])
  customerName  String
  customerEmail String
  customerPhone String
  totalAmount   Decimal
  status        OrderStatus @default(pending)
  items         OrderItem[]
  payment       Payment?
  notes         String? // Customer notes or special instructions
  pickedUpAt    DateTime? // When customer actually picked up
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  version       Int         @default(1) // Optimistic locking for concurrent admin access

  // Critical indexes for order management at scale
  @@index([userId]) // User's orders
  @@index([status]) // Order status filtering
  @@index([status, createdAt(sort: Desc)]) // Status + date filtering
  @@index([createdAt(sort: Desc)]) // Recent orders
  @@index([customerEmail]) // Customer lookup
}

model Payment {
  id              String        @id @default(uuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Decimal
  referenceNumber String? // GCash reference number from the receipt
  proofImageUrl   String // URL to the uploaded GCash proof of payment screenshot
  status          PaymentStatus @default(pending)
  rejectionReason String? // Reason if payment is rejected
  verifiedBy      String? // Admin user ID who verified
  verifiedAt      DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status]) // Payment status filtering
  @@index([status, createdAt(sort: Desc)]) // Pending payments queue
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Decimal

  @@index([orderId]) // Order items lookup
  @@index([productId]) // Product sales analytics
  @@index([productId, quantity]) // Top selling products aggregation
}

model InventoryLog {
  id        String   @id @default(uuid())
  productId String
  change    Int
  reason    String
  createdAt DateTime @default(now())

  @@index([productId]) // Product history
  @@index([productId, createdAt(sort: Desc)]) // Recent changes per product
}

model Settings {
  id    String @id @default(uuid())
  key   String @unique
  value String
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId])
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  name      String   // Store product name at time of adding
  price     Decimal  // Store price at time of adding
  image     String?  // Store image URL
  quantity  Int      @default(1)
  size      String?
  color     String?
  category  String?
  subcategory String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId, size, color]) // Prevent duplicate items with same variant
  @@index([cartId])
  @@index([productId])
}

model Wishlist {
  id        String         @id @default(uuid())
  userId    String         @unique
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  String
  name       String   // Store product name at time of adding
  price      Decimal  // Store price at time of adding
  image      String?  // Store image URL
  category   String?
  subcategory String?
  createdAt  DateTime @default(now())

  @@unique([wishlistId, productId]) // Prevent duplicate products in wishlist
  @@index([wishlistId])
  @@index([productId])
}
